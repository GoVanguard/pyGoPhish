{% extends "pondering/layout.html" %}
{% block content %}
<div class="jumbotron">
    {% if user.is_authenticated %}
    <h4>Welcome {{ user.name }}!</h4>
    <p class="lead" id="userPrompt">When would you like to go phishing?</p>
    <form action="/gophish" id="form" method="post">
        <label for="domain">Domain: http://www.</label>
        <input type="text" id="domain" name="domain" value="" required>
        <label for="domain" id="lag">0 ms</label>
        <br/>
        <label for="datetime">Date:</label>
        <input type="datetime-local" id="datetime" name="datetime" autocomplete="on" value="">
        <input type="submit" id="prompt" value="Schedule" disabled>
        <br/>
        <input type="checkbox" id="urgent" name="urgent">
        <label for="urgent">Schedule immediately.</label>
    </form>
    {% else %}
    <h1>PyGoPhish - Please sign in to phish.</h1>
    <a href="{% url 'signin' %}" class="btn btn-primary btn-large">Click here to sign in</a>
    {% endif %}
</div>
<script>
    let form = document.getElementById("form");
    form.addEventListener("load", check);
    form.addEventListener("input", check);
    window.onload = (event) => {check()};
    let ping = new Ping();
    let lag
    setup()

    function debug() {
        const userPrompt = document.getElementById("userPrompt").innerHTML;
        const domain = document.getElementById("domain").value;
        const uDateTime = document.getElementById("datetime").value;
        const uPrompt = document.getElementById("prompt").value;
        const urgent = document.getElementById("urgent").checked;
        console.log(userPrompt);
        console.log(domain);
        console.log(uDateTime);
        console.log(uPrompt);
        console.log(urgent);
    }

    function setup() {
        const cDate = new Date();
        time = convertDateTime(cDate);
        document.getElementById("datetime").value = time;
    }

    function check() {
        const userPrompt = document.getElementById("userPrompt");
        const domain = document.getElementById("domain").value;
        const uDateTime = document.getElementById("datetime");
        const uPrompt = document.getElementById("prompt");
        const urgent = document.getElementById("urgent").checked;
        if(urgent && !domain) {
            uPrompt.value = "Next";
            uDateTime.type = "hidden";
            userPrompt.innerHTML = "Immediately? Please enter a domain.";
            uPrompt.disabled = true;
        }
        else if(urgent && domain) {
            uPrompt.value = "Next";
            uDateTime.type = "hidden";
            if(validateDomain(domain)) {
                userPrompt.innerHTML = "Immediately? The boat awaits!";
                uPrompt.disabled = false;
	    }
            else {
                userPrompt.innerHTML = "That is not a valid domain.";
                uPrompt.disabled = true;
            }
        }
        else if(domain && validateSchedule(uDateTime.value)) {
            uPrompt.value = "Schedule";
            uDateTime.type = "datetime-local";
            if(validateDomain(domain)) {
                userPrompt.innnerHTML = "Immediately? The boat awaits!";
                uPrompt.disabled = false;
	    }
            else {
                userPrompt.innerHTML = "This is not a valid domain.";
                uPrompt.disabled = true;
            }
        }
        else {
            uPrompt.value = "Schedule";
            uDateTime.type = "datetime-local";
            userPrompt.innerHTML = "When would you like to go phishing?";
            if(validateSchedule(uDateTime)) {
                uPrompt.disabled = false;
            }
            else {
                uPrompt.disabled = true;
            }
        }
    }

    function validateDomain(domain) {
        if(/^[a-z0-9]+([-.][a-z0-9]+)*\.[a-z]{2,}$/i.test(domain)) {
            result = ping.ping("http://www." + domain,(err, data) => {
                if (err) {
                    console.log("error loading resource", err);
                }
            });
        if(result.then((state) => {
           document.getElementById("lag").innerHTML = state + " ms"; 
        })) { 
            return true;
        }
        else {
            return false;
        }
        }
    }

    function validateSchedule(uDateTime) {
        quasiValid = /([2-9][0-9][2-9][0-9][-])(([0][1-9])|([1][0-2]))([-](([0][1-9])|([1-2][0-9])|([3][0-1]))[T])((([0-1][0-9])|([2][0-3]))[:]([0-5][0-9]))|([2-9][1-9][0-9][0-9][-])(([0][1-9])|([1][0-2]))([-](([0][1-9])|([1-2][0-9])|([3][0-1]))[T])((([0-1][0-9])|([2][0-3]))[:]([0-5][0-9]))|([3-9][0-9][0-9][0-9][-])(([0][1-9])|([1][0-2]))([-](([0][1-9])|([1-2][0-9])|([3][0-1]))[T])((([0-1][0-9])|([2][0-3]))[:]([0-5][0-9]))|([0-9]{5,}[-])(([0][1-9])|([1][0-2]))([-](([0][1-9])|([1-2][0-9])|([3][0-1]))[T])((([0-1][0-9])|([2][0-3]))[:]([0-5][0-9]))/g.test(uDateTime);
            if(quasiValid) {
                leapYear = leapYearCheck(uDateTime);
                    if(uDateTime.slice(5,7) == "02" && uDateTime.slice(8,10) > 28 && !leapYear) {
                        return false;
                    }
                    else if(uDateTime.slice(5,7) == "02" && uDateTime.slice(8,10) > 29 && leapYear) {
                        return false;
                    }
                    else if((uDateTime.slice(5,7) == "04" || uDateTime.slice(5,7) == "06" || uDateTime.slice(5,7) == "09" ||
                           uDateTime.slice(5,7) == "11") && uDateTime.slice(8.10) > 30) {
                        return false;
                    }
                    else if(uDateTime.slice(8,10) > 31) {
                        return false;
                    }
                    else {
                        return true;
                    }
            }
            else {
                return false;
            }
    }

    function leapYearCheck(uDateTime) {
        if(uDateTime%4 == 0) {
            if(uDateTime%100 == 0) {
                if(uDateTime%400 == 0) {
                    return true;
                }
                else {
                    return false;
                }
            }
            else {
                return true;
            }
        }
        else {
            return false;
        }
    }

    function convertDateTime(cDate) {
        time = cDate.getFullYear() + '-' + ((parseInt(cDate.getMonth()) + 1)<10?'0':'') + (parseInt(cDate.getMonth()) + 1) + '-' + (cDate.getDate()<10?'0':'') + cDate.getDate() + 'T' + (cDate.getHours()<10?'0':'') + cDate.getHours() + ':' + (cDate.getMinutes()<10?'0':'') + cDate.getMinutes();
        return time
    }
 
    /**
     * Creates a Ping instance.
     * @returns {Ping}
     * @constructor
     */

    function Ping(opt) {
        this.opt = opt || {};
        this.favicon = this.opt.favicon || "/favicon.ico";
        this.timeout = this.opt.timeout || 0;
        this.logError = this.opt.logError || false;
    };

    /**
     * Pings source and triggers a callback when completed.
     * @param {string} source Source of the website or server, including protocol and port.
     * @param {Function} callback Callback function to trigger when completed. Returns error and ping value.
     * @returns {Promise|undefined} A promise that both resolves and rejects to the ping value.
     * Or undefined if the browser does not support Promise.
     */

    Ping.prototype.ping = function(source, callback) {
        var promise, resolve, reject;
        if (typeof Promise !== "undefined") {
            promise = new Promise(function(_resolve, _reject) {
                resolve = _resolve;
                reject = _reject;
            });
        }

        var self = this;
        self.wasSuccess = false;
        self.img = new Image();
        self.img.onload = onload;
        self.img.onerror = onerror;

        var timer;
        var start = new Date();

        function onload(e) {
            self.wasSuccess = true;
            pingCheck.call(self, e);
        }

        function onerror(e) {
            self.wasSuccess = false;
            pingCheck.call(self, e);
        }

        if (self.timeout) {
            timer = setTimeout(function() {
                pingCheck.call(self, undefined);
        }, self.timeout); }


        /**
         * Times ping and triggers callback.
         */
        function pingCheck() {
            if (timer) { clearTimeout(timer); }
            var pong = new Date() - start;

            if (!callback) {
                if (promise) {
                    return this.wasSuccess ? resolve(pong) : reject(pong);
                } else {
                    throw new Error("Promise is not supported by your browser. Use callback instead.");
                }
            } else if (typeof callback === "function") {
                // When operating in timeout mode, the timeout callback doesn't pass [event] as e.
                // Notice [this] instead of [self], since .call() was used with context
                if (!this.wasSuccess) {
                    if (self.logError) { console.error("error loading resource"); }
                    if (promise) { reject(pong); }
                    return callback("error", pong);
                }
                if (promise) { resolve(pong); }
                return callback(null, pong);
            } else {
                throw new Error("Callback is not a function.");
            }
        }

        self.img.src = source + self.favicon + "?" + (+new Date()); // Trigger image load with cache buster
        return promise;
    };

    if (typeof exports !== "undefined") {
        if (typeof module !== "undefined" && module.exports) {
            module.exports = Ping;
        }
    } else {
        window.Ping = Ping;
    } 
</script>
{% endblock %}
